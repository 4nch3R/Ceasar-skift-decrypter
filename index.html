<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Caesar-dekryptering med bokstavmatching</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
        input { width: 300px; padding: 6px; font-size: 16px; }
        button { padding: 8px 12px; font-size: 15px; }
        #output { margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>

<h2>Caesar-dekryptering med bokstavmatching</h2>

<label for="cipher">Kryptert tekst:</label><br>
<input id="cipher" type="text" placeholder="f.eks. OFLJWKQDLJW">
<button onclick="analyze()">Analyser</button>

<canvas id="chart" width="600" height="300"></canvas>

<div id="output"></div>

<script>
let norwegianWordsSet = new Set();

// ---------------------------
// Last inn ordlisten
// ---------------------------
fetch('ordliste.txt')
  .then(response => response.text())
  .then(data => {
    // Anta ett ord per linje
    norwegianWordsSet = new Set(data.split(/\r?\n/).map(w => w.toLowerCase()));
    console.log("Ordbok lastet: " + norwegianWordsSet.size + " ord");
  });

// ---------------------------
// Caesar-dekryptering
// ---------------------------
function caesarDecrypt(text, shift) {
    return text.split("").map(c => {
        if (c < 'A' || c > 'Z') return c;
        let code = c.charCodeAt(0) - 65;
        return String.fromCharCode(((code - shift + 26) % 26) + 65);
    }).join("");
}

// ---------------------------
// Beregn prosentvis bokstavmatch
// ---------------------------
function letterMatchScore(word) {
    const w = word.toLowerCase();

    // Finn det beste matching-ordet i ordlisten
    let maxMatch = 0;

    norwegianWordsSet.forEach(ow => {
        // Kun ord som er omtrent samme lengde Â± 3 bokstaver
        if (Math.abs(ow.length - w.length) > 3) return;

        let matches = 0;
        for (let i = 0; i < Math.min(ow.length, w.length); i++) {
            if (w[i] === ow[i]) matches++;
        }
        let score = (matches / w.length) * 100; // prosent av bokstavene som matcher
        if (score > maxMatch) maxMatch = score;
    });

    return maxMatch;
}

// ---------------------------
// Analysefunksjon
// ---------------------------
let chartInstance = null;

function analyze() {
    const cipher = document.getElementById("cipher").value.toUpperCase().trim();
    if (!cipher) return;

    const shifts = [];
    const labels = [];
    const probabilities = [];

    for (let s = 1; s <= 25; s++) {
        const plain = caesarDecrypt(cipher, s);
        const score = letterMatchScore(plain);

        shifts.push({shift: s, text: plain, probability: score});
        labels.push("Shift " + s);
        probabilities.push(score.toFixed(1));
    }

    // Finn maksimal score
    const best = shifts.reduce((a, b) => a.probability > b.probability ? a : b);

    // Vis resultater
    document.getElementById("output").innerHTML =
        `<h3>Mest sannsynlige dekryptering:</h3>
        <p><b>${best.text}</b> (Shift ${best.shift}, score ${best.probability.toFixed(1)}%)</p>
        <h3>Alle dekrypteringer:</h3>
        <pre>${shifts.map(s => `${s.shift}: ${s.text}  [${s.probability.toFixed(1)}%]`).join("\n")}</pre>`;

    drawChart(labels, probabilities);
}

// ---------------------------
// Tegn graf med Chart.js
// ---------------------------
function drawChart(labels, data) {
    const ctx = document.getElementById("chart").getContext("2d");

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Bokstavmatch (%)",
                data: data,
                backgroundColor: "rgba(54, 162, 235, 0.7)"
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: "Prosent" }
                }
            }
        }
    });
}
</script>

</body>
</html>
