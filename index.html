<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Caesar-dekryptering med substrings</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
        input { width: 300px; padding: 6px; font-size: 16px; }
        button { padding: 8px 12px; font-size: 15px; }
        #output { margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>

<h2>Caesar-dekryptering med substring-match</h2>

<label for="cipher">Kryptert tekst:</label><br>
<input id="cipher" type="text" placeholder="f.eks. OFLJWKQDLJW">
<button onclick="analyze()">Analyser</button>

<canvas id="chart" width="600" height="300"></canvas>
<div id="output"></div>

<script>
let norwegianWordsSet = new Set();

// ---------------------------
// Last inn ordlisten
// ---------------------------
fetch('ordliste.txt')
  .then(response => response.text())
  .then(data => {
    norwegianWordsSet = new Set(data.split(/\r?\n/).map(w => w.toLowerCase()));
    console.log("Ordbok lastet: " + norwegianWordsSet.size + " ord");
  });

// ---------------------------
// Caesar-dekryptering
// ---------------------------
function caesarDecrypt(text, shift) {
    return text.split("").map(c => {
        if (c < 'A' || c > 'Z') return c;
        let code = c.charCodeAt(0) - 65;
        return String.fromCharCode(((code - shift + 26) % 26) + 65);
    }).join("");
}

// ---------------------------
// Finn beste substring-match
// ---------------------------
function bestSubstringMatch(word) {
    const w = word.toLowerCase();
    let maxScore = 0;

    norwegianWordsSet.forEach(ow => {
        const o = ow.toLowerCase();
        if (o.length > w.length) return;

        // Sjekk alle mulige startposisjoner i w
        for (let i = 0; i <= w.length - o.length; i++) {
            const sub = w.substring(i, i + o.length);
            if (sub === o) {
                const score = (o.length / w.length) * 100;
                if (score > maxScore) maxScore = score;
            }
        }
    });

    return maxScore;
}

// ---------------------------
// Analysefunksjon
// ---------------------------
let chartInstance = null;
function analyze() {
    const cipher = document.getElementById("cipher").value.toUpperCase().trim();
    if (!cipher) return;

    const shifts = [];
    const labels = [];
    const probabilities = [];

    for (let s = 1; s <= 25; s++) {
        const plain = caesarDecrypt(cipher, s);
        const score = bestSubstringMatch(plain);

        shifts.push({shift: s, text: plain, probability: score});
        labels.push("Shift " + s);
        probabilities.push(score.toFixed(1));
    }

    const best = shifts.reduce((a, b) => a.probability > b.probability ? a : b);

    document.getElementById("output").innerHTML =
        `<h3>Mest sannsynlige dekryptering:</h3>
        <p><b>${best.text}</b> (Shift ${best.shift}, score ${best.probability.toFixed(1)}%)</p>
        <h3>Alle dekrypteringer:</h3>
        <pre>${shifts.map(s => `${s.shift}: ${s.text}  [${s.probability.toFixed(1)}%]`).join("\n")}</pre>`;

    drawChart(labels, probabilities);
}

// ---------------------------
// Tegn graf med Chart.js
// ---------------------------
function drawChart(labels, data) {
    const ctx = document.getElementById("chart").getContext("2d");
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Prosent match med ordliste",
                data: data,
                backgroundColor: "rgba(54, 162, 235, 0.7)"
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: "Prosent (%)" }
                }
            }
        }
    });
}
</script>

</body>
</html>
